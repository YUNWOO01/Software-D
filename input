#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include "header.h"

/* 外部シンボル（globals.c に実体がある前提） */
extern MEM data[USERNUM];
extern void tk_select(int, int, int);

/* mailbox API は header.h にプロトタイプがある想定 */
extern void mailbox_list(int ln);
extern void mailbox_play(int ln, int idx);
extern void mailbox_delete(int ln, int idx);
extern void init_mailboxes(void);

/* 安全に1行読むユーティリティ */
static int read_line(char *buf, size_t sz)
{
    if (!fgets(buf, (int)sz, stdin)) return 0;
    size_t L = strlen(buf);
    if (L > 0 && buf[L-1] == '\n') buf[L-1] = '\0';
    return 1;
}

/* data の実体（USERNUM に合わせて定義） */
MEM data[USERNUM];

/* 起動時初期化：電話番号・状態・フラグ等を設定する */
void init_data(void)
{
    for (int i = 0; i < USERNUM; ++i) {
        data[i].telnum = 0;
        data[i].state = idle;
        data[i].terminal = 0;
        data[i].or_ac = YES;
        data[i].or_ter_ident = terminate;
    }
    /* 通常、端末インデックスは 1 〜 USERNUM-1 を使うので 1 から設定 */
    for (int i = 1; i <= USERNUM - 1; ++i) {
        data[i].telnum = 4000 + i;
        data[i].state = idle;
        data[i].terminal = 0;
        data[i].or_ac = YES;           /* 発信許可（初期は許可） */
        data[i].or_ter_ident = terminate;
    }
}

/* 状態名取得（表示用） */
static const char *state_name(int st)
{
    switch (st) {
        case idle:     return "idle";
        case dialtone: return "dialtone";
        case ringing:  return "ringing";
        case talk:     return "talk";
        case busy:     return "busy";
        default:       return "0";
    }
}

/* 個別データ表示メニュー（表示を元ログに合わせる） */
static void show_individual_data(void)
{
    char line[64];
    int cont = 1;
    while (cont) {
        printf("個別データ情報\n");
        printf("状態(1),発信を拒否する端末(2),相手端末(3),発着識別子(4),留守電(5)>");
        fflush(stdout);
        if (!read_line(line, sizeof(line))) return;
        int choice = atoi(line);

        if (choice == 1) {
            printf("Terminal   State\n");
            printf("------------------------\n");
            for (int i = 1; i <= USERNUM - 1; i++) {
                printf("%8d%12s\n", i, state_name(data[i].state));
            }
        } else if (choice == 2) {
            printf("Terminal   Accept Flag\n");
            printf("------------------------\n");
            for (int i = 1; i <= USERNUM - 1; i++) {
                printf("%8d%12s\n", i, (data[i].or_ac == NO) ? "DENIAL" : "ACCEPT");
            }
        } else if (choice == 3) {
            printf("Terminal   Partner\n");
            printf("------------------------\n");
            for (int i = 1; i <= USERNUM - 1; i++) {
                printf("%8d%12d\n", i, data[i].terminal);
            }
        } else if (choice == 4) {
            printf("Terminal   Orig/Term\n");
            printf("------------------------\n");
            for (int i = 1; i <= USERNUM - 1; i++) {
                const char *s = (data[i].or_ter_ident == originate) ? "ORIG" : "TERMINATE";
                printf("%8d%12s\n", i, s);
            }
        } else if (choice == 5) {
            /* 留守電メニュー：端末を指定して一覧/再生/削除 */
            printf("留守電一覧を表示します。どの端末を見ますか？>");
            fflush(stdout);
            if (!read_line(line, sizeof(line))) return;
            int t = atoi(line);
            if (t < 1 || t > USERNUM - 1) {
                printf("端末番号範囲外\n");
            } else {
                int cont2 = 1;
                while (cont2) {
                    mailbox_list(t);
                    printf("再生=1, 削除=2, 戻る=0 >");
                    fflush(stdout);
                    if (!read_line(line, sizeof(line))) return;
                    int op = atoi(line);
                    if (op == 1) {
                        printf("再生するメッセージ番号を入力>");
                        fflush(stdout);
                        if (!read_line(line, sizeof(line))) return;
                        int midx = atoi(line);
                        mailbox_play(t, midx);
                    } else if (op == 2) {
                        printf("削除するメッセージ番号を入力>");
                        fflush(stdout);
                        if (!read_line(line, sizeof(line))) return;
                        int midx = atoi(line);
                        mailbox_delete(t, midx);
                    } else if (op == 0) {
                        break;
                    } else {
                        printf("無効な選択です\n");
                    }
                    printf("他の操作を行いますか？ Yes=1 No=0 >");
                    fflush(stdout);
                    if (!read_line(line, sizeof(line))) return;
                    cont2 = atoi(line);
                }
            }
        } else {
            printf("無効な選択です\n");
        }

        printf("他の情報見ますか？ Yes=1 No=0 >");
        fflush(stdout);
        if (!read_line(line, sizeof(line))) return;
        cont = atoi(line);
    }
}

/* main ループ：入力行を文字列で受け、先頭の非空白文字を見て 'i' を判定する */
int main(void)
{
    char line[128];
    int initchg = 0;
    int ln, sig, num;
    char buf[128];

    /* 起動初期化 */
    init_data();
    init_mailboxes();

    printf("■□■□設計演習C Ver.1.3 ■□■□\n");
    printf("初期設定変更を行いますか？Yes=1 No=0 >");
    fflush(stdout);
    if (!read_line(line, sizeof(line))) return 0;
    initchg = atoi(line);

    if (initchg > 0) {
        /* ユーザーが "初期設定を行う" と答えたら、
           1つの端末番号を入力して設定を行い、その直後に再度
           "初期設定変更を行いますか？" と確認する流れに変更 */
        while (initchg > 0) {
            printf("発信を許可しない端末番号入力>");
            fflush(stdout);
            if (!read_line(line, sizeof(line))) { initchg = 0; break; }
            int t = atoi(line);
            if (t == 0) break;
            if (t < 1 || t > USERNUM - 1) {
                printf("端末番号範囲外\n");
            } else {
                data[t].or_ac = NO;
                printf("端末[%d]を発信不可にしました．\n", t);
            }

            /* 端末1件の入力後、改めて初期設定を続けるか確認する */
            printf("初期設定変更を行いますか？Yes=1 No=0 >");
            fflush(stdout);
            if (!read_line(line, sizeof(line))) { initchg = 0; break; }
            initchg = atoi(line);
        }
    }

    for (;;) {
        /* 端末番号プロンプト（USERNUM が 5 の場合は 1-4 を表示） */
        printf("端末番号(1-%d)>", USERNUM - 1);
        fflush(stdout);
        if (!read_line(buf, sizeof(buf))) break;

        /* 先頭の空白をスキップして先頭文字を調べる */
        char *p = buf;
        while (*p && isspace((unsigned char)*p)) p++;

        /* 'i' または 'I' を先頭に入力したら個別データメニューへ */
        if (*p == 'i' || *p == 'I') {
            show_individual_data();
            continue;
        }

        /* 数字でない先頭文字は範囲外扱い */
        if (!isdigit((unsigned char)*p) && *p != '+' && *p != '-') {
            printf("端末番号範囲外\n");
            continue;
        }

        ln = atoi(p);
        if (ln < 1 || ln > USERNUM - 1) {
            printf("端末番号範囲外\n");
            continue;
        }

        /* イベント入力（3:留守電 を追加、4: 留守電メニュー追加） */
        printf("イベント(0:offhook   1:onhook   2:dial   3:留守電   4:留守電メニュー)>");
        fflush(stdout);
        if (!read_line(buf, sizeof(buf))) break;
        /* 同様に空白をスキップして判定 */
        p = buf;
        while (*p && isspace((unsigned char)*p)) p++;
        /* イベントでも 'i' を受け付けたい場合はここに同様の判定を追加 */
        if (!isdigit((unsigned char)*p) && *p != '+' && *p != '-') {
            printf("未定義のイベントです\n");
            continue;
        }
        sig = atoi(p);

        if (sig == 4) {
            /* イベント側から端末の留守電メニューを開く */
            int contm = 1;
            while (contm) {
                mailbox_list(ln);
                printf("再生=1, 削除=2, 戻る=0 >");
                fflush(stdout);
                if (!read_line(line, sizeof(line))) { contm = 0; break; }
                int op = atoi(line);
                if (op == 1) {
                    printf("再生するメッセージ番号を入力>");
                    fflush(stdout);
                    if (!read_line(line, sizeof(line))) break;
                    int midx = atoi(line);
                    mailbox_play(ln, midx);
                } else if (op == 2) {
                    printf("削除するメッセージ番号を入力>");
                    fflush(stdout);
                    if (!read_line(line, sizeof(line))) break;
                    int midx = atoi(line);
                    mailbox_delete(ln, midx);
                } else if (op == 0) {
                    break;
                } else {
                    printf("無効な選択です\n");
                }
                printf("他の操作を行いますか？ Yes=1 No=0 >");
                fflush(stdout);
                if (!read_line(line, sizeof(line))) { contm = 0; break; }
                contm = atoi(line);
            }
            continue;
        }

        if (sig == dial) {
            printf("電話番号(4001-4004)>");
            fflush(stdout);
            if (!read_line(buf, sizeof(buf))) break;
            p = buf;
            while (*p && isspace((unsigned char)*p)) p++;
            if (!isdigit((unsigned char)*p) && *p != '+' && *p != '-') {
                printf("無効な電話番号\n");
                continue;
            }
            num = atoi(p);
            /* 電話番号の簡易チェック */
            if (num < 4001 || num > 4000 + (USERNUM - 1)) {
                printf("無効な電話番号\n");
                continue;
            }
        } else {
            num = 0;
        }

        /* 留守電イベントを選んだらメッセージを出して busy に設定 */
        if (sig == 3) {
            printf("[%d]=>留守電に設定します\n", ln);
            data[ln].state = busy;
            /* 必要なら tk_select も呼んでタスク側の処理を行う */
            tk_select(ln, 3, 0);
            continue;
        }

        /* メイン処理へ渡す（それ以外のイベント）*/
        tk_select(ln, sig, num);
    }

    printf("終了します\n");
    return 0;
}
